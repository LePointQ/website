{{ define "main" }}
	<main>
		<h1 class='balance-text'>{{ .Title | replaceRE "\"[^\"]*\"" "&laquo;&nbsp;$0&nbsp;&raquo;" | replaceRE "\"" "" | markdownify }}</h1>

		<div class='edito'>
			{{ .Params.edito | replaceRE "\"[^\"]*\"" "&laquo;&nbsp;$0&nbsp;&raquo;" | replaceRE "\"" "" | markdownify }}
		</div>

		{{ if gt (len .Params.temoignages) 0 }}
			{{ with .Site.GetPage .Params.temoignages }}
				<article id='temoignages'>
					<p class='separator'>● ● ●</p>

					<img src="{{ .Site.BaseURL }}{{ .Params.image }}" class='hero' />
					<h2 class='balance-text'>
						<img src="{{ .Site.BaseURL }}/media/icons/temoignages.svg" width="40" class='icon' />
						{{ .Title | replaceRE "\"[^\"]*\"" "&laquo;&nbsp;$0&nbsp;&raquo;" | replaceRE "\"" "" | markdownify }}
					</h2>
					{{ if gt (len .Params.authors) 0 }}
						<h3 class='authors'>
							{{ if eq (len .Params.authors) 1 }}
								<img src="{{ .Site.BaseURL }}/media/team/{{ index .Params.authors 0 }}.jpg" width="40" height="40" class="author-pic" />
							{{ end }}
							<span style="">Par {{ delimit .Params.authors ", " " & " }}</span>
						</h3>
					{{ end }}

					{{ .Params.text | replaceRE "\"[^\"]*\"" "&laquo;&nbsp;$0&nbsp;&raquo;" | replaceRE "\"" "" | markdownify }}
				</article>
			{{ end }}
		{{ end }}

		{{ if gt (len .Params.vu_d_ailleurs) 0 }}
			{{ with .Site.GetPage .Params.vu_d_ailleurs }}
				<article id='vu-d-ailleurs'>
					<p class='separator'>● ● ●</p>

					<img src="{{ .Site.BaseURL }}{{ .Params.image }}" class='hero' />

					<h2>
						<img src="{{ .Site.BaseURL }}/media/icons/vu_d_ailleurs.svg" width="40" class='icon' />
						Vu d’ailleurs
					</h2>
					{{ if gt (len .Params.authors) 0 }}
						<h3 class='authors'>
							{{ if eq (len .Params.authors) 1 }}
								<img src="{{ .Site.BaseURL }}/media/team/{{ index .Params.authors 0 }}.jpg" width="40" height="40" class="author-pic" />
							{{ end }}
							<span style="">Par {{ delimit .Params.authors ", " " & " }}</span>
						</h3>
					{{ end }}
					<h4 class='balance-text'>{{ .Title | replaceRE "\"[^\"]*\"" "&laquo;&nbsp;$0&nbsp;&raquo;" | replaceRE "\"" "" | markdownify }}</h4>

					{{ .Params.text | replaceRE "\"[^\"]*\"" "&laquo;&nbsp;$0&nbsp;&raquo;" | replaceRE "\"" "" | markdownify }}
				</article>
			{{ end }}
		{{ end }}

		{{ if gt (len .Params.on_debunke) 0 }}
			{{ with .Site.GetPage .Params.on_debunke }}
				<article id='on-debunke'>
					<p class='separator'>● ● ●</p>

					<img src="{{ .Site.BaseURL }}{{ .Params.image }}" class='hero' />

					<h2>
						<img src="{{ .Site.BaseURL }}/media/icons/on_debunke.svg" width="40" class='icon' />
						On débunke&nbsp;!
					</h2>
					{{ if gt (len .Params.authors) 0 }}
						<h3 class='authors'>
							{{ if eq (len .Params.authors) 1 }}
								<img src="{{ .Site.BaseURL }}/media/team/{{ index .Params.authors 0 }}.jpg" width="40" height="40" class="author-pic" />
							{{ end }}
							<span style="">Par {{ delimit .Params.authors ", " " & " }}</span>
						</h3>
					{{ end }}
					<h4 class='balance-text'>{{ .Title | replaceRE "\"[^\"]*\"" "&laquo;&nbsp;$0&nbsp;&raquo;" | replaceRE "\"" "" | markdownify }}</h4>

					{{ if eq .Params.veracity "Faux" }}
						<p class='veracity fake'>FAUX</p>
					{{ else if eq .Params.veracity "Vrai" }}
						<p class='veracity true'>VRAI</p>
					{{ else }}
						<p class='veracity trueish'>PAS EXACTEMENT</p>
					{{ end }}

					{{ .Params.text | replaceRE "\"[^\"]*\"" "&laquo;&nbsp;$0&nbsp;&raquo;" | replaceRE "\"" "" | markdownify }}
				</article>
			{{ end }}
		{{ end }}

		{{ if gt (len .Params.la_bonne_nouvelle) 0 }}
			{{ with .Site.GetPage .Params.la_bonne_nouvelle }}
				<article id='la-bonne-nouvelle'>
					<p class='separator'>● ● ●</p>

					<img src="{{ .Site.BaseURL }}{{ .Params.image }}" class='hero' />

					<h2>
						<img src="{{ .Site.BaseURL }}/media/icons/la_bonne_nouvelle.svg" width="40" class='icon' />
						La bonne nouvelle
					</h2>
					{{ if gt (len .Params.authors) 0 }}
						<h3 class='authors'>
							{{ if eq (len .Params.authors) 1 }}
								<img src="{{ .Site.BaseURL }}/media/team/{{ index .Params.authors 0 }}.jpg" width="40" height="40" class="author-pic" />
							{{ end }}
							<span style="">Par {{ delimit .Params.authors ", " " & " }}</span>
						</h3>
					{{ end }}
					<h4 class='balance-text'>{{ .Title | replaceRE "\"[^\"]*\"" "&laquo;&nbsp;$0&nbsp;&raquo;" | replaceRE "\"" "" | markdownify }}</h4>

					{{ .Params.text | replaceRE "\"[^\"]*\"" "&laquo;&nbsp;$0&nbsp;&raquo;" | replaceRE "\"" "" | markdownify }}
				</article>
			{{ end }}
		{{ end }}

		{{ if .Params.plume_morgan }}
			<article id='plume-morgan'>
				<p class='separator'>● ● ●</p>

				<h2>
					<img src="{{ .Site.BaseURL }}/media/icons/plume_morgan.svg" width="40" class='icon' />
					Sous la plume de Morgan
				</h2>

				<br />

				<img src="{{ .Site.BaseURL }}{{ .Params.plume_morgan }}" class='hero' />
			</article>
		{{ end }}

		<p class='separator'>● ● ●</p>

		<div class='outro'>
			{{ .Params.outro | replaceRE "\"[^\"]*\"" "&laquo;&nbsp;$0&nbsp;&raquo;" | replaceRE "\"" "" | markdownify }}
		</div>

	</main>
	{{ partial "paywall" }}
{{ end }}

{{ define "page-style" }}
	<style>
		h1 {
			margin-bottom: 2rem;
		}
	</style>
{{ end }}

{{ define "page-script" }}
	<script>
		window.addEventListener('load', () => {
			if (window.location.hostname !== 'localhost' && sessionStorage.getItem('status') !== 'subscribed') {
				document.querySelector('.paywall').classList.add('visible');
				document.querySelector('main').classList.add('blurred');
			}
		});

		document.querySelector('#unlock').addEventListener('submit', async (e) => {
			e.preventDefault();
			document.querySelectorAll('.paywall *:not(.separator)').forEach(e => e.style.visibility = 'hidden');
			document.querySelector('.paywall > .separator').classList.add('animated');
			const response = await fetch("https://europe-west1-le-point-q.cloudfunctions.net/isContact?email=" + e.target.email.value);
			const { status } = await response.json();
			if (status === 'subscribed') {
				document.querySelector('main').classList.remove('blurred');
				document.querySelector('.paywall').classList.remove('visible');
				sessionStorage.setItem('status', 'subscribed');
			}
			else {
				document.querySelectorAll('.paywall *:not(.separator)').forEach(e => e.style.visibility = 'visible');
				document.querySelector('.paywall .separator').classList.remove('animated');
			}
		});

		document.querySelector('#subscribe').addEventListener('submit', async (e) => {
			e.preventDefault();
			const referrer = sessionStorage.getItem('referrer');
			fetch('https://europe-west1-le-point-q.cloudfunctions.net/addContact?email=' + e.target.email.value + '&referrer=' + referrer);
			document.querySelector('main').classList.remove('blurred');
			document.querySelector('.paywall').classList.remove('visible');
			sessionStorage.setItem('status', 'subscribed');
		});
	</script>
{{ end }}
